FROM alpine:3.15

LABEL "wordpress-version"="6.2.2"
LABEL "mariadb-version"="10.11.4-r0"
LABEL "php-version"="7.4.33-r1"
LABEL "wget-version"="1.21.4-r0"

ARG APP_USER=www-data WORDPRESS_VERSION=6.2.2  MARIADB_VERSION=10.11.4-r0 PHP_VERSION=7.4.33-r1 WGET_VERSION=1.21.4-r0

RUN delgroup ${APP_USER} && addgroup -S ${APP_USER} && adduser -S ${APP_USER} -G ${APP_USER}

WORKDIR /app

RUN apk update && apk add --no-cache curl \
    wget=${WGET_VERSION} \
    php7=${PHP_VERSION} \ 
    php7-phar=${PHP_VERSION} \
    php7-fpm=${PHP_VERSION} \ 
    php7-opcache=${PHP_VERSION} \
    php7-gd=${PHP_VERSION} \
    php7-mysqli=${PHP_VERSION} \
    php7-zlib=${PHP_VERSION} \
    php7-curl=${PHP_VERSION} \
    php7-mbstring=${PHP_VERSION} \
    php7-json=${PHP_VERSION} \
    php7-session=${PHP_VERSION} \
    mariadb-client=${MARIADB_VERSION}

COPY ./tools/ /app/

RUN chown -R ${APP_USER}:${APP_USER} /app && \
    chmod -R 750 /app && \
    chown -R ${APP_USER}:${APP_USER} /var/log/php7 && \
    chmod -R 755 /var/log/php7

RUN wget https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && \
	chmod +x wp-cli.phar && mv wp-cli.phar /usr/local/bin/wp

WORKDIR /usr/share/webapps/wordpress

RUN wp core download --version=${WORDPRESS_VERSION} && \
    chown -R ${APP_USER}:${APP_USER} /usr/share/webapps && \
    chmod -R 755 /usr/share/webapps

USER ${APP_USER}:${APP_USER}

ENTRYPOINT ["/app/init.sh"]